<%# locals: { plan, research_output, research_output_types } %>
<% template_locale = plan.template.locale %>
<% research_outputs.each_with_index do |research_output, index|%>
  <% research_output_description = research_output&.json_fragment&.research_output_description %>
  <% research_output_data = research_output_description.data if research_output_description.present?%>
  <% contact = research_output_description.contact%>
  <%= form_for research_output, url: plan_research_output_path(:id => research_output.id, :plan_id => plan.id), html: {method: :put, remote: true, id: nil } do |f| %>
    <div class='research-output-element <%= index != 0 ? '' : 'inactive' %>'>
      <%= hidden_field_tag 'research-output-id', research_output.id, class: 'research-output-id' %>
      <div class='research-output-fields'>
        <div class='research-output-field form-group research-output-abbreviation'>
          <%= f.label :abbreviation, d_('dmpopidor', 'Abbreviated Name (20 chars max.)'), class: 'control-label' %>
          <%= f.text_field :abbreviation, maxlength: 20, 
                           class: 'form-control input edit',
                           "aria-required": true, required: true,
                           "data-toggle": "tooltip", title: d_('dmpopidor', 'Research output name (20 chars max.)') %>
          <span class="readonly"><%= research_output.abbreviation %></span>
        </div>
        <div class='research-output-field form-group research-output-fullname'>
          <%= f.label :fullname, d_('dmpopidor', 'Full Title'),  class: 'control-label' %>
          <%= f.text_field :fullname, value: research_output_data['title'],
                           class: 'form-control input edit',
                           "aria-required": true, required: true,
                           "data-toggle": "tooltip", title: d_('dmpopidor', 'Research output fullname')   %>
          <span class="readonly"><%= research_output_data['title'] %></span>
        </div>
        <% unless plan.template.structured? %>
          <div class='research-output-field form-group research-output-type'>
            <% registryValues = Registry.find_by(name:"ResearchDataType").registry_values %>
            <%= f.label :other_type_label, d_('dmpopidor', 'Type'),  class: 'control-label' %>
            <%= select_tag "research_output[other_type_label]",
                        options_for_select(
                            registryValues.map {|v| [ 
                                    v.to_s(template_locale), 
                                    select_value(v, template_locale) 
                                ] 
                            },
                            selected: research_output_data['type']
                        ),
                        include_blank: true,
                        "data-toggle": "tooltip",
                        class: "form-control input edit",
                        "aria-required": true,
                        id: "other_type_label"  %>
            <span class="readonly"><%= research_output_data['type'] %></span>
          </div>
          <div class='research-output-field form-group research-output-contact'>
            <% personsList = research_output_description.dmp.persons %>
            <%= f.label "contact_id", d_('dmpopidor', 'Contact'),  class: 'control-label' %>
            <span class="input edit">
              <%= render(partial: 'shared/dynamic_form/fields/fragment_select_field', locals: {
                f: f,
                selected_value: contact.person,
                readonly: false,
                parent_id: contact.id,
                dmp_id: research_output_description.dmp_id,
                schema: MadmpSchema.find_by(name: "PersonStandard"),
                required: true,
                template_locale: template_locale,
                property_name: nil,
                field_id: "contact_#{contact.id}_person", field_name: "contact_id",
                multiple: false,
                field_label: nil, ttip: nil, answer_id: nil 
                }
              ) %>
            </span>
            <span class="readonly"><%= contact.person.to_s %></span>
          </div>
          <div class='research-output-field form-group research-output-pid'>
            <%= f.label :pid, d_('dmpopidor', 'Persistent Identifier'),  class: 'control-label' %>
            <%= f.text_field :pid, value: research_output_data['datasetId'], class: 'form-control input edit', "aria-required": true,
                        'data-toggle': 'tooltip', title: d_('dmpopidor', 'If exists, please fill in the research output persistant identifier.')   %>
            <span class="readonly"><%= research_output_data['datasetId'] %></span>
          </div>
        <% end %>
        <div class='research-output-actions pull-right' style="width:25%">
          <%= f.submit _('Save'), class: "btn btn-primary edit" %>
          <button type="button" class="btn btn-secondary cancel"><%= _('Cancel') %></button>
        </div>
      </div>
      <% unless readonly %>
        <div class='research-output-actions'>
            <i class="fa fa-edit edit" aria-hidden="true" data-toggle="tooltip" 
                    data-original-title="<%= d_('dmpopidor', 'Edit research output') %>"></i>
          <% if plan.research_outputs.length > 1 && index != 0 %>
            <i class="fa fa-arrows handle" aria-hidden="true" data-toggle="tooltip" 
                    data-original-title="<%= d_('dmpopidor', 'Move research output') %>"></i>
                    
            <%= link_to plan_research_output_url(plan, research_output), 
                        target: "_self",
                        data: {:confirm => d_('dmpopidor', 'Deleting this research output will remove the associated answers. Do you confirm ?')}, 
                        :method => :delete  do %>
              <i class="fa fa-close delete" aria-hidden="true" data-toggle="tooltip" 
                    data-original-title="<%= d_('dmpopidor', 'Delete research output') %>" %></i>
            <% end %>
          <% end %>
        </div>
      <% end %>
      <hr/>
    </div>
  <% end %>
<% end %>