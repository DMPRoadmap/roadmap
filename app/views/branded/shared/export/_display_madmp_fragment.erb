<% sub_schemas = schema.sub_schemas %>
<% data = fragment.data unless fragment.nil? %>
<% dmp_fragments = fragment.present? ? fragment.dmp_fragments() : [] %>
<% schema_properties = schema.schema["properties"]%>
<% schema_properties.each do |key, prop| %>
  <% value = data[key] unless data.nil? %>
  <% label = prop["label@#{locale}"] %>
  <% next if value.nil? %>
  <% case prop['type'] %>
  <% when 'boolean' %>
    <div class="fragment-property">
      <span class="property-label"><%= label %></span>
      <span class="property-value"><%= value ? _('Yes') : _('No') %></span>
    </div>
  <% when 'array' %>
    <% if prop['items']['type'] == 'object' && prop['items']['schema_id'].present? %>
      <%
        sub_schema = sub_schemas[prop['items']['schema_id']]
        table_header = prop["table_header@#{locale}"] ? prop["table_header@#{locale}"] : prop["table_header"]
        values = []
        if value.present?
          values = dmp_fragments.where(id: data[key].map { |d| d["dbid"] })
        end
      %>
      <% unless values.empty? %>
        <% values.each_with_index do |val, idx| %>
          <span class="fragment-property fragment-list">
            <span class="property-label"><%= label if idx.eql?(0) %></span> 
            <span class="property-value"><%= val.to_s %></span> 
          </span>
        <% end %>
      <% end %>
    <% else %>
      <span class="fragment-property">
        <span class="property-label"><%= label %></span>
        <span class="property-value"><%=  value.join(", ") %></span>
      </span>
    <% end %>
  <% when 'object' %>
    <% sub_fragment = dmp_fragments.find(value["dbid"]) %>
    <% next if sub_fragment.data.nil? || sub_fragment.data.compact.empty? %>
    <% if sub_fragment.classname.eql?("contributor")  || prop["registry_id"].present? %>
      <span class="fragment-property">
        <span class="property-label"><%= label %></span> 
        <span class="property-value"><%= sub_fragment.to_s %></span> 
      </span>
    <% else %>
      <fieldset class="fragment-display">
        <legend><%= label %></legend>
        <%= render(partial: 'shared/export/display_madmp_fragment', locals: {
                    fragment: sub_fragment,
                    schema: sub_fragment.madmp_schema,
                    classname: sub_fragment.classname,
                    locale: locale
        })%>
      </fieldset>
    <% end %>
  <% else%>
    <span class="fragment-property">
      <span class="property-label"><%= label %></span>
      <span class="property-value"><%= value.to_s.html_safe %></span>
    </span>
  <% end %>
<% end %>