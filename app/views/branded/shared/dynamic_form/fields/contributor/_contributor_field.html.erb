<%# locals: { f, field_label, persons, contributors, contributor_schema, current_fragment, readonly, ttip, template_locale } %>
<% parent_id = current_fragment.id %>
<% role_property = contributor_schema.schema["properties"]["role"] %>
<% role_label = role_property["label@#{template_locale}"]%>
<% role_tooltip= role_property["tooltip@#{template_locale}"]%>
<% roles = RegistryValue.where(registry_id: role_property["registry_id"])%>
<% query_id = Digest::MD5.hexdigest("#{current_fragment.id}-#{property_name}") %>
<div class="col-md-12 dynamic-field contributor-field">
  <fieldset class="sub-fragment">
    <legend class="sub-fragment" data-toggle="tooltip" data-original-title="<%= ttip %>"><%= field_label %></legend>
    <%= render(partial: 'shared/dynamic_form/form', locals: { 
                    f: f, 
                    current_fragment: current_fragment,
                    schema: contributor_schema,
                    question_id: nil,
                    readonly: readonly,
                    classname: contributor_schema.classname,
                    form_prefix: nil,
                    template_locale: template_locale,
                    source: "form"
                  }) %>

    <div class="col-md-12">
      <% unless parent_id.nil? || readonly %>
        <span class="btn btn-primary assign-role"
              data-toggle="tooltip"
              data-original-title="<%= d_("dmpopidor", "Click here to assign a role to this user") %>"
              data-locale="<%= template_locale %>"
              data-parent-id="<%= parent_id %>"
              data-query-id="<%= query_id %>"
              data-property-name="<%= property_name %>"
              data-schema-id="<%= contributor_schema.id %>"
        >
          <%= d_('dmpopidor', 'Confirm') %>
        </span>
      <% end %>
    </div>

    <div class="col-md-12">
      <table class="table table-hover linked-fragments-list <%= property_name %>-list list-<%= query_id %>">
        <thead>
        </thead>
        <tbody>
          <%= render(partial: 'shared/dynamic_form/fields/contributor/contributor_list', locals: {
                  contributors: contributors, 
                  parent_id: parent_id,
                  schema_id: contributor_schema.id,
                  readonly: true,
                  deletable: !readonly,
                  template_locale: template_locale,
                  property_name: property_name,
                  query_id: query_id
                }
              ) %>
        </tbody>
      </table>
    </div>
  </fieldset>
</div>