<% helpers = ActionController::Base.helpers %>

$(() => {
  $('#modal-window').html('<%= escape_javascript(render "shared/dynamic_form/modal") %>');

  $('#modal-window').modal({backdrop: 'static'});

  $('#modal_fragment_form').on('ajax:success', (event, response) => {
    if (response.classname === 'research_output') {
      $('#research-outputs-list').html(response.html);
    } else if (response.source === 'list-modal') {
      const queryId = $(event.target).find('.query_id').val();
      $(`table.list-${queryId} tbody`).html(response.html);
    } else {
      const queryId = $(event.target).find('.query_id').val();
      const $select = $(`.select-${queryId} select`);
      $select.html(response.html);
      $select.val(response.fragment_id).trigger('select2:select');
      $select.val(response.fragment_id).trigger('change');
    }
    $('#modal-window').modal('hide');
  }).on('ajax:error', (event, response)=> {
    const target = $(event.target);
    const errorMessage = response.responseJSON.error;
    target.find('.message-area').html(errorMessage).addClass('alert-danger');
  });

  $('#modal-window form :input').on('change', () => {
    $('#modal-window button[type=submit]').attr('disabled', false);
  });
});
