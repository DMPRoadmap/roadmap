<%# locals: { template, question, fragment, madmp_schema, research_output, readonly, locking } %>
<% url = fragment.present? ? madmp_fragment_path(id: fragment.id) : load_new_form_madmp_fragments_path %>
<% new_form_class = fragment.nil? ? "new-fragment" : ""%>

<%= form_for :madmp_fragment, url: url, 
              html: {
                method: :post, 
                'data-autosave': question.id, 
                class: "form-answer dynamic-form #{new_form_class}", 
                id: nil  
              } do |f| %>
  <% if !readonly %>
    <%= f.fields_for(:answer, answer) do |af| %>
      <%= af.hidden_field :plan_id, id: nil %>
      <%= af.hidden_field :question_id, id: nil %>
      <%= af.hidden_field :lock_version, id: nil %>
      <%= af.hidden_field :research_output_id, :value => research_output.id, id: nil%>
      <%= af.hidden_field :is_common, class: 'ans_is_common' if research_output.main? %>
      <%= af.hidden_field :id, id: nil, class: 'answer_id' %>
    <% end %>
  <% end %>
  <%= f.hidden_field :schema_id, :value => madmp_schema.id, id: nil, class: "schema_id" %>
  <%= f.hidden_field :dmp_id, :value => dmp_id, id: nil %>
  <%= f.hidden_field :parent_id, :value => parent_id, id: nil %>
  <%= f.hidden_field "source", :value => "form" %>
  <fieldset aria-labelledby="answer-fieldset">
    <% classname = fragment.classname unless fragment.nil? %>
    <% if fragment.present? %>
      <div class="form-group madmp-fragment fragment-<%= fragment.id %>">   
        <%= render(partial: 'shared/dynamic_form/form', locals: { 
              f: f,
              fragment: fragment, 
              schema: madmp_schema,
              question_id: question.id, 
              readonly: readonly,
              classname: classname,
              fragment_id: fragment.id,
              template_locale: question.template.locale
            }) %>
        <div class="overlay" style="display:none;">
          <div class="spinner"></div>
          <br/>
          <%= _('Saving...') %>
        </div>
      </div>
      <%= f.button(_('Save'), class: "btn btn-default", type: "submit") %>
    <% else %>
      <div class="form-group madmp-fragment">  
        <div class="overlay" style="display:none;">
          <div class="spinner"></div>
          <br/>
          <%= _('Loading ...') %>
        </div>
      </div>
    <% end %>
  </fieldset>
<% end %>